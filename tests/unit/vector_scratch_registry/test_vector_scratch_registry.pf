module test_vector_scratch_registry
  use pfunit
  use vector
  use vector_math
  use vector_scratch_registry
  use comm, only : NEKO_COMM, pe_rank, pe_size
  use num_types
  implicit none

contains

  @test
  subroutine test_vector_scratch_registry_init_default()
    type(vector_scratch_registry_t) :: scratch
    integer :: ierr

    call scratch%init()

    @assertEqual(scratch%get_nvectors(), 0)
    @assertEqual(scratch%get_expansion_size(), 10)
    @assertEqual(scratch%get_size(), 10)
    @assertEqual(scratch%get_nvectors_inuse(), 0)

  end subroutine test_vector_scratch_registry_init_default

  @test
  subroutine test_vector_scratch_registry_init()
    type(vector_scratch_registry_t) :: scratch
    integer :: ierr

    call scratch%init(5, 3)

    @assertEqual(scratch%get_nvectors(), 0)
    @assertEqual(scratch%get_expansion_size(), 3)
    @assertEqual(scratch%get_size(), 5)
    @assertEqual(scratch%get_nvectors_inuse(), 0)

  end subroutine test_vector_scratch_registry_init

  @test
  subroutine test_vector_scratch_registry_request_vector_fresh()
    type(vector_scratch_registry_t) :: scratch
    type(vector_t), pointer :: v1, v2, v3
    integer :: ierr, index1, index2, index3

    ! write(*,*) "TEST FRESH"

    call scratch%init(5, 3)

    call scratch%request_vector(42, v1, index1)
    call scratch%request_vector(42, v2, index2)
    call scratch%request_vector(42, v3, index3)
    @assertEqual(index1, 1)
    @assertEqual(index2, 2)
    @assertEqual(scratch%get_inuse(index1), .true.)
    @assertEqual(scratch%get_inuse(index2), .true.)
    @assertEqual(scratch%get_nvectors(), 3)
    @assertEqual(scratch%get_nvectors_inuse(), 3)

    ! do something with the vector
    call vector_cfill(v1, 1.0_rp)
    call vector_cfill(v2, 2.0_rp)
    call vector_cfill(v3, 3.0_rp)
    @assertEqual(v1%x(1), 1.0_rp)
    @assertEqual(v2%x(1), 2.0_rp)
    @assertEqual(v3%x(1), 3.0_rp)
  end subroutine test_vector_scratch_registry_request_vector_fresh

  @test
  subroutine test_vector_scratch_registry_relinquish_vector()
    type(vector_scratch_registry_t) :: scratch
    type(vector_t), pointer :: v
    integer :: ierr, index
    !
    call scratch%init(5, 3)

    call scratch%request_vector(42, v, index)
    call scratch%relinquish_vector(index)
    @assertEqual(scratch%get_inuse(index), .false.)
    @assertEqual(scratch%get_nvectors_inuse(), 0)
    @assertEqual(scratch%get_nvectors(), 1)
  end subroutine test_vector_scratch_registry_relinquish_vector

  @test
  subroutine test_vector_scratch_registry_expand()
    type(vector_scratch_registry_t), target :: scratch
    type(vector_t), pointer :: v1, v2
    integer :: ierr, index1, index2

    ! write(*,*) "TEST EXPAND"

    call scratch%init(1, 1)

    call scratch%request_vector(42, v1, index1)
    call vector_cfill(v1, 1.0_rp)
    @assertEqual(v1%x(1), 1.0_rp)

    ! add new vector, trigging expand
    call scratch%request_vector(84, v2, index2)

    ! try to use the second vector
    call vector_cfill(v2, 2.0_rp)

    ! make sure values in v1 preserved after expansion
    @assertEqual(v1%x(1), 1.0_rp)
    @assertEqual(v2%x(1), 2.0_rp)
    @assertEqual(v1%size(), 42)
    @assertEqual(v2%size(), 84)
    @assertEqual(index1, 1)
    @assertEqual(index2, 2)
    @assertEqual(scratch%get_inuse(index1), .true.)
    @assertEqual(scratch%get_inuse(index2), .true.)
    @assertEqual(scratch%get_nvectors(), 2)
    @assertEqual(scratch%get_nvectors_inuse(), 2)
    @assertEqual(scratch%get_size(), 2)
  end subroutine test_vector_scratch_registry_expand

  @test
  subroutine test_vector_scratch_registry_combo()
    type(vector_scratch_registry_t), target :: scratch
    type(vector_t), pointer :: v1, v2, v3
    integer :: ierr, index1, index2, index3

    !  write(*,*) "TEST COMBO"
    call scratch%init(2, 2)

    ! add 2 vectors, no expansion
    call scratch%request_vector(42, v1, index1)
    call scratch%request_vector(42, v2, index2)
    call vector_cfill(v1, 1.0_rp)
    call vector_cfill(v2, 2.0_rp)

    @assertEqual(index1, 1)
    @assertEqual(index2, 2)
    @assertEqual(scratch%get_inuse(index1), .true.)
    @assertEqual(scratch%get_inuse(index2), .true.)
    @assertEqual(scratch%get_nvectors(), 2)
    @assertEqual(scratch%get_nvectors_inuse(), 2)
    @assertEqual(scratch%get_size(), 2)

    ! get rid of one vector
    call scratch%relinquish_vector(index1)
    @assertEqual(scratch%get_inuse(index1), .false.)
    @assertEqual(scratch%get_inuse(index2), .true.)
    @assertEqual(scratch%get_nvectors(), 2)
    @assertEqual(scratch%get_nvectors_inuse(), 1)
    @assertEqual(scratch%get_size(), 2)

    ! get a new vector, should get index 1
    call scratch%request_vector(42, v1, index1)
    call vector_cfill(v1, 1.5_rp)
    @assertEqual(index1, 1)
    @assertEqual(scratch%get_inuse(index1), .true.)
    @assertEqual(scratch%get_inuse(index2), .true.)
    @assertEqual(scratch%get_nvectors(), 2)
    @assertEqual(scratch%get_nvectors_inuse(), 2)
    @assertEqual(scratch%get_size(), 2)

    ! check that the vectors have survived
    @assertEqual(v1%x(1), 1.5_rp)
    @assertEqual(v2%x(1), 2.0_rp)

    ! get a another vector, should get index 3 and triger expand
    call scratch%request_vector(42, v3, index3)
    call vector_cfill(v3, 3.0_rp)
    @assertEqual(index3, 3)
    @assertEqual(scratch%get_inuse(index1), .true.)
    @assertEqual(scratch%get_inuse(index2), .true.)
    @assertEqual(scratch%get_inuse(index3), .true.)
    @assertEqual(scratch%get_nvectors(), 3)
    @assertEqual(scratch%get_nvectors_inuse(), 3)
    @assertEqual(scratch%get_size(), 4)

    ! check that the vectors have survived
    @assertEqual(v1%x(1), 1.5_rp)
    @assertEqual(v2%x(1), 2.0_rp)
    @assertEqual(v3%x(1), 3.0_rp)


  end subroutine test_vector_scratch_registry_combo

  @test
  subroutine test_vector_scratch_registry_array_indices()
    type(vector_scratch_registry_t), target :: scratch
    type(vector_t), pointer :: v1, v2, v3
    integer :: ierr
    integer :: indices(3)

    !  write(*,*) "TEST COMBO"
    call scratch%init(2, 2)

    ! add 2 vectors, no expansion
    call scratch%request_vector(42, v1, indices(1))
    call scratch%request_vector(42, v2, indices(2))
    call scratch%request_vector(42, v3, indices(3))

    @assertEqual(indices(1), 1)
    @assertEqual(indices(2), 2)
    @assertEqual(indices(3), 3)

    call vector_cfill(v1, 1.0_rp)
    call vector_cfill(v2, 2.0_rp)
    call vector_cfill(v3, 2.0_rp)

    ! get rid of the vectors
    call scratch%relinquish_vector(indices)
    @assertEqual(scratch%get_inuse(indices(1)), .false.)
    @assertEqual(scratch%get_inuse(indices(2)), .false.)
    @assertEqual(scratch%get_inuse(indices(3)), .false.)
    @assertEqual(scratch%get_nvectors(), 3)
    @assertEqual(scratch%get_nvectors_inuse(), 0)

    ! get a new vector, should get index 1
    call scratch%request_vector(42, v1, indices(1))
    call vector_cfill(v1, 1.5_rp)
    @assertEqual(indices(1), 1)
    @assertEqual(scratch%get_inuse(indices(1)), .true.)
    @assertEqual(scratch%get_nvectors(), 3)
    @assertEqual(scratch%get_nvectors_inuse(), 1)

  end subroutine test_vector_scratch_registry_array_indices
end module test_vector_scratch_registry

#!/bin/sh -e

prefix=@prefix@
exec_prefix=@exec_prefix@
libdir=${exec_prefix}/lib
includedir_pkg=${prefix}/include/neko
FC=@FC@
FCFLAGS='@FCFLAGS@'

printf "\n%s\n" 'N E K O build tool, Version @PACKAGE_VERSION@'
printf "%s\n" '@NEKO_BUILD_INFO@'


if [ -z "$1" ]
  then
      echo "No user file provided"
      exit 1
fi
printf '\n%s' "Building user NEKO ..."
rm -f usr_driver.f90

# Find all user-defined modules (excluding 'user')
user_modules=$(grep -hE '^[[:space:]]*module[[:space:]]+[a-zA-Z_][a-zA-Z0-9_]*' *.f90 | \
               grep -vE '^[[:space:]]*!' | \
               grep -vE 'module procedure' | \
               awk '{if ($2 != "user") print $2}' | sort -u)


cat >> usr_driver.f90 << _ACEOF
program usrneko
  use neko
  use user
_ACEOF

# Automatically import user modules
for mod in $user_modules; do
  echo "  use $mod, only: ${mod}_register_types" >> usr_driver.f90
done

cat >> usr_driver.f90 << _ACEOF

  type(case_t), target :: C

  ! Call register_types() for all modules
  call user_setup(C%usr)
_ACEOF

# Generate calls to renamed `register_types` routines
for mod in $user_modules; do
  echo "  call ${mod}_register_types()" >> usr_driver.f90
done

cat >> usr_driver.f90 << _ACEOF
  call neko_init(C)
  call neko_solve(C)
  call neko_finalize(C)

end program usrneko
_ACEOF

$FC $FCFLAGS -I$includedir_pkg -L$libdir $@ usr_driver.f90\
    -lneko @LDFLAGS@ @LIBS@ -o neko

rm -f usr_driver.f90

printf "%s\n" ' done!'

#!/bin/sh -e

prefix=@prefix@
exec_prefix=@exec_prefix@
libdir=${exec_prefix}/lib
includedir_pkg=${prefix}/include/neko
FC=@FC@
FCFLAGS='@FCFLAGS@'

# Ensure user provides at least one .f90 file
if [ $# -eq 0 ]; then
    echo "Usage: makeneko <file1.f90> <file2.f90>"
    exit 1
fi

# Collect user-provided .f90 files (excluding usr_driver.f90)
USER_FILES=""
for file in "$@"; do
    if [ "$file" != "plugins.txt" ] && [ "$file" != "usr_driver.f90" ]; then
        USER_FILES="$USER_FILES $file"
    fi
done

# Extract module names from user-provided .f90 files
USER_MODULES=$(grep -hE '^[[:space:]]*module[[:space:]]+[a-zA-Z_][a-zA-Z0-9_]*' $USER_FILES 2>/dev/null | \
               grep -vE '^[[:space:]]*!' | \
               grep -vE 'module procedure|module[[:space:]]+user' | \
               awk '{print $2}' | sort -u)

echo "Detected the following user modules:"
echo $USER_MODULES

# Create usr_driver.f90
cat > usr_driver.f90 << _ACEOF
program usrneko
  use neko
  use user
_ACEOF

# Insert `use` statements for local user .f90 files
for mod in $USER_MODULES; do
  echo "  use $mod" >> usr_driver.f90
done

cat >> usr_driver.f90 << _ACEOF

  type(case_t), target :: C

  ! Register all user-defined types
  call user_setup(C%usr)
_ACEOF

# Register types from local user .f90 files
for mod in $USER_MODULES; do
  echo "  call ${mod}_register_types()" >> usr_driver.f90
done

cat >> usr_driver.f90 << _ACEOF
  call neko_init(C)
  call neko_solve(C)
  call neko_finalize(C)

end program usrneko
_ACEOF

# Compile everything
$FC $FCFLAGS -I$includedir_pkg -L$libdir $USER_FILES usr_driver.f90 -lneko @LDFLAGS@ @LIBS@ -o neko

rm -f usr_driver.f90
echo "User NEKO build complete!"

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Neko: Performance guidelines</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Neko<span id="projectnumber">&#160;1.99.2</span>
   </div>
   <div id="projectbrief">A portable framework for high-order spectral element flow simulations</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('dc/d3c/performance.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Performance guidelines</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md131">Installation</a><ul><li class="level2"><a href="#autotoc_md132">Accelerator specific options</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md133">Simulation setup</a><ul><li class="level2"><a href="#autotoc_md134">Load balancing</a></li>
<li class="level2"><a href="#autotoc_md135">Parameters</a></li>
</ul>
</li>
<li class="level1"><a href="#autotoc_md136">Running a simulation</a></li>
</ul>
</div>
<div class="textblock"><p>This is a short best practices guideline on how to achieve good performance with Neko across various architectures. The guide covers various configuration options, as well as advice on how to set up and run simulations to achieve the best possible performance.</p>
<h1><a class="anchor" id="autotoc_md131"></a>
Installation</h1>
<p>When building Neko, it is important to enable full optimisation for all configured backends. Configuring with <code>FCFLAGS</code> and <code>CFLAGS</code> to <code>-O3</code> will provide an optimal build for CPUs and SX-Aurora backends, while for accelerators, a user needs to set <code>CUDA_CFLAGS</code> or <code>HIP_HIPCC_FLAG</code> depending on the backend type (OpenCL optimisation is set in via the <code>CFLAGS</code> variable). Additional performance could also be gained for both CPUs and GPUs by passing architecture-specific configuration flags, either via <code>FCFLAGS</code> and <code>CFLAGS</code> (CPU, SX, and OpenCL), <code>HIP_HIPCC_FLAGS</code> (HIP), or <code>CUDA_ARCH</code> (CUDA).</p>
<h2><a class="anchor" id="autotoc_md132"></a>
Accelerator specific options</h2>
<p>To avoid unnecessary data movement between host and device, it is important to use a device-aware MPI implementation and configure Neko with <code>--enable-device-mpi</code> for the CUDA and HIP backend. Furthermore, to improve GPU utilisation, especially with few elements per device, it could be beneficial to configure Neko to use OpenMP <code>--enable-openmp</code>, and launch the simulation with two threads. This would enable the task-parallel preconditioners inside Neko.</p>
<dl class="section note"><dt>Note</dt><dd>In the current release, OpenMP is only used to launch jobs concurrently into different accelerator streams. Thus, no gains should be expected from OpenMP when using a CPU backend.</dd></dl>
<h1><a class="anchor" id="autotoc_md133"></a>
Simulation setup</h1>
<p>This section explains how to set up and select options for a case to achieve the best possible simulation performance.</p>
<h2><a class="anchor" id="autotoc_md134"></a>
Load balancing</h2>
<p>Load balancing is essential for good simulation performance. This can be performed using graph partitioning of the mesh, either offline or online (during a simulation with Neko). Both options require Neko to be built with the optional dependency ParMetis (see <a class="el" href="../../d5/dfc/installation.html">Installing Neko</a>).</p>
<p>The offline tool is called <code>prepart</code>, and is installed in the same installation directory as <code>neko</code> and <code>makeneko</code>. To partition a mesh into <code>nparts</code>, launch <code>prepart</code> as below:</p>
<div class="fragment"><div class="line">./prepart &lt;neko mesh&gt; &lt;nparts&gt;</div>
</div><!-- fragment --><p>The output will be a new mesh, with an additional <code>_&lt;nparts&gt;</code> in the filename to indicate that it has been balanced for <code>nparts</code>.</p>
<dl class="section note"><dt>Note</dt><dd>The offline tool can require substantial memory to partition large meshes.</dd></dl>
<p>To enable load balancing (mesh partitioning) during a simulation, set the <code>load_balancing</code> option to <code>true</code> (see <a class="el" href="../../dd/d33/case-file.html">Case File</a>). Runtime load balancing will partition the mesh (in parallel) before the time-stepping loop starts, and it will also save the balanced mesh with an additional <code>_lb</code> in the filename.</p>
<dl class="section note"><dt>Note</dt><dd>Since mesh partitioning is non-deterministic, care has to be taken when restarting a simulation such that one does not i) restart with load balancing enabled and ii) use the original unbalanced mesh. The suggested workflow is to run the first simulation with load balancing enabled, and for all subsequent restarts, turn off load balancing and use the balanced mesh with the additional <code>_lb</code> in the filename.</dd></dl>
<h2><a class="anchor" id="autotoc_md135"></a>
Parameters</h2>
<p>Depending on the configured backend, some simulation parameters can significantly impact performance, for example, the polynomial order. For CPU backends, performance is less sensitive to the chosen order and should be set depending on the accuracy and time-to-solution needs of a given case. On accelerators, performance and device utilisation are closely tied to the polynomial order. In general, accelerators run best with the highest possible polynomial order. However, using a very high order will force down the required time-step size and, in turn, increase the time-to-solution for a given case. A good rule of thumb is to use at least seventh-order polynomials for accelerator backends.</p>
<p>Another important parameter to experiment with to improve performance is the combination of linear solver and preconditioner, and their associated tolerance criteria. The best combination is very case dependent, thus it is best to experiment with the various types provided (see <a class="el" href="../../dd/da8/namespacecase.html" title="Defines a simulation case.">case</a>-file).</p>
<h1><a class="anchor" id="autotoc_md136"></a>
Running a simulation</h1>
<p>When running a simulation, the only parameter a user has some control over is the number of MPI ranks to use. Neko will always distribute a mesh across all ranks in a job using a load-balanced linear distribution. With too few elements per rank, communication costs will start to dominate, reducing both scalability and performance. The opposite, with too many elements per rank, will cause computational cost (per rank) to increase at the cost of a reduced (overall) parallel efficiency.</p>
<p>Neko has been optimised with strong scalability in mind, and has demonstrated nearly ideal scaling and parallel efficiency with as few as 10 elements per MPI rank on CPUs or 7000-10000 elements per MPI rank on GPUs.</p>
<dl class="section note"><dt>Note</dt><dd>Given the significant computational capacity of GPUs, ideal strong scalability, with as few elements per device as possible, is not a guarantee of achieving the best time-to-solution. It is often better to fill each GPU with as many elements as possible within the device's memory. The indicative numbers given above (7000-10000 elements) should be seen as the capability of Neko to scale out a problem across a large machine efficiently.</dd></dl>
<p>Finally, achieved performance depends on many factors, for example, the interconnect; it is therefore advisable to invest time in establishing a performance baseline the first time a new machine is used. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Neko Manual</a></li><li class="navelem"><a class="el" href="../../dd/d04/user-guide.html">User guide</a></li>
    <li class="footer">Generated on Tue Dec 23 2025 03:52:36 for Neko by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Neko: Run-time selectable types</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Neko<span id="projectnumber">&#160;0.9.99</span>
   </div>
   <div id="projectbrief">A portable framework for high-order spectral element flow simulations</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('d5/d5f/rts_types.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Run-time selectable types</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>It is often necessary to determine the type of objects at run time, for example, based on user input. Neko implements the factory pattern to that end. The associated code structure can be found in many components of the code, so it worth becoming familiar with it. Here we will use the LES models as an example.</p>
<p>The creation of objects is organized as follows. A base abstract type is defined, that will serve as the parent of all the types that can be constructed by the factory. In our example, this is <code>les_model_t</code>. A type is abstract if it defines at least one <code>deferred</code> procedure. This means that the procedure is not implemented in the type itself, but all descendants of the type <em>must</em> implement it. Crucial to our setup here is that the base abstract type defines a deferred constructor, always called <code>init</code> (with a few exceptions). This means that all descendants can be constructed using the same subroutine dummy arguments. These dummy arguments are defined in an <code>abstract interface</code>. The example below shows the interface for the constructor of all LES models. It is quite common that a deferred destructor is defined, called <code>free</code>. In the case of LES models, the routine <code>compute</code> is also deferred; this is where the models compute the subgrid viscosity.</p>
<div class="fragment"><div class="line">abstract <span class="keyword">interface</span></div>
<div class="line">   <span class="keyword">subroutine </span>les_model_init(this, dofmap, coef, json)</div>
<div class="line">     <span class="keywordtype">import </span>les_model_t, json_file, dofmap_t, coef_t</div>
<div class="line">     <span class="keywordtype">class</span>(les_model_t), <span class="keywordtype">intent(inout)</span> :: this</div>
<div class="line">     <span class="keywordtype">type</span>(coef_t), <span class="keywordtype">intent(in)</span> :: coef</div>
<div class="line">     <span class="keywordtype">type</span>(dofmap_t), <span class="keywordtype">intent(in)</span> :: dofmap</div>
<div class="line">     <span class="keywordtype">type</span>(json_file), <span class="keywordtype">intent(inout)</span> :: json</div>
<div class="line">   <span class="keyword">end subroutine </span>les_model_init</div>
<div class="line"><span class="keyword">end interface</span></div>
</div><!-- fragment --><p>As discussed above, the descendants of the abstract type implement different variations of the functionality in question, in our case LES models. One such type is <code><a class="el" href="../../d2/d13/smagorinsky_8f90.html">smagorinsky.f90</a></code>, which implements the Smagorinsky model. Of course, an implementation of all deferred routines is present in the type.</p>
<p>The factory iteself is just a subroutine. It lives in a separate file, which ends with <code>_fctry.f90</code>, so <code><a class="el" href="../../d6/dff/les__model__fctry_8f90.html">les_model_fctry.f90</a></code> in our example. The factory accepts a pointer to the base abstract type as one of its dummy arguments, usually called <code>object</code>. This pointer is to be allocated to one of the descendants of the abstract type. The factory chooses what type to allocate simply based on a provided name. In the top of the factory module, type names known to the factory are listed in a variable ending with <code>KNOWN_TYPES</code>. The name is typically passed to the dummy argument called <code>type_name</code>. This name could, for example, be read from the case file. For LES models, one provides the <code>model</code> keyword in the case file, and this gets passed to the factory. So if <code>"model": "smagorinsky"</code> is in the case file, the factory will allocate the pointer to a <code>smagorinsky_t</code> and initialize it using the common <code>init</code> constructor. Calling <code>compute</code> on the allocated pointer will then run the routine defined for the <code>smagorinsky_t</code> type.</p>
<p>For the particular case of LES models, the pointer to <code>les_model_t</code> is stored in the simcomp <code><a class="el" href="../../d0/d0d/namespaceles__simcomp.html" title="Implements the les_simcomp_t type.">les_simcomp</a></code>. Note that it is defined as <code>class</code>, not <code>type</code>. This is necessary to make use of polymorphism, i.e. that the pointer can "act" as any of its descendants after being allocated to one. The factory is then called in the <code>init</code> routine of the simcomp.</p>
<div class="fragment"><div class="line"><span class="keyword">type</span>, <span class="keyword">public</span>, <span class="keyword">extends</span>(simulation_component_t) :: les_simcomp_t</div>
<div class="line">  <span class="keywordtype">class</span>(les_model_t), <span class="keywordtype">allocatable</span> :: les_model</div>
</div><!-- fragment --><p>So, what needs to be done to add a new LES model? Simple, one creates a new type descending from <code>les_model_t</code>, implements all the deferred routines, adds the type name to the known types of the factory, and finally expands the <code>if</code> statement in the factory to allocate to the new type given the corresponding type name. The same steps are followed for a lot of other functionality! There are some minor variations, for example, not all factories initialize the object, some just allocate it and leave the construction to the callee. Eventually these differences may be ironed out. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Neko Manual</a></li><li class="navelem"><a class="el" href="../../dc/d70/developer-guide.html">Developer guide</a></li>
    <li class="footer">Generated on Thu Dec 19 2024 03:41:26 for Neko by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>

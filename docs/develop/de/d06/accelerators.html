<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Neko: Accelerators</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Neko<span id="projectnumber">&#160;0.9.99</span>
   </div>
   <div id="projectbrief">A portable framework for high-order spectral element flow simulations</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('de/d06/accelerators.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Accelerators</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#autotoc_md3">Device abstraction layer</a><ul><li class="level2"><a href="#autotoc_md4">Memory management</a><ul><li class="level3"><a href="#autotoc_md5">Allocation/deallocation</a></li>
<li class="level3"><a href="#autotoc_md6">Associate data on host and device</a></li>
<li class="level3"><a href="#autotoc_md7">Map a host array to a device</a></li>
<li class="level3"><a href="#accelerators_data-transfer">Data transfer</a></li>
</ul>
</li>
<li class="level2"><a href="#accelerators_offload-work">Offload work</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="autotoc_md3"></a>
Device abstraction layer</h1>
<p>Neko has a device abstraction layer (<a class="el" href="../../d4/d2a/device_8F90.html">device.F90</a>) to manage device memory, data transfer and kernel invocations directly from a familiar Fortran interface, targeting all supported accelerator backends.</p>
<h2><a class="anchor" id="autotoc_md4"></a>
Memory management</h2>
<h3><a class="anchor" id="autotoc_md5"></a>
Allocation/deallocation</h3>
<p>Allocating device memory can be done via the low-level <a class="el" href="../../d0/dbe/namespacedevice.html#a87905d572ea607609a71d54effdb0ab9" title="Allocate memory on the device.">device::device_alloc</a> function, which takes a C pointer and requested size (in bytes) as arguments (see below). The pointer points to the allocated device memory if the allocation is successful. <br  />
 </p><div class="fragment"><div class="line"><span class="keywordtype">type</span>(c_ptr) :: x_d</div>
<div class="line"><span class="keywordtype">integer(c_size_t)</span> :: size</div>
<div class="line">...</div>
<div class="line"><span class="keyword">call </span>device_alloc(x_d, size)</div>
</div><!-- fragment --><p>To deallocate device memory, call <a class="el" href="../../d0/dbe/namespacedevice.html#a79e3ce634472f542b8d135571f7a36e0" title="Deallocate memory on the device.">device::device_free</a> as shown below. </p><div class="fragment"><div class="line"><span class="keywordtype">type</span>(c_ptr) :: x_d</div>
<div class="line">...</div>
<div class="line"><span class="keyword">call </span>device_free(x_d)</div>
</div><!-- fragment --> <h3><a class="anchor" id="autotoc_md6"></a>
Associate data on host and device</h3>
<p>It is often helpful to associate a Fortran array with an array allocated on the device. This can be done via the <a class="el" href="../../d6/d17/interfacedevice_1_1device__associate.html" title="Associate a Fortran array to a (allocated) device pointer.">device::device_associate</a> routine, which takes a Fortran array <code>x</code> of type <code>integer</code>, <code>integer(i8)</code>, <code>real(kind=sp)</code> or <code>real(kind=dp)</code> (of maximum rank four) and a device pointer <code>x_d</code> as arguments. </p><div class="fragment"><div class="line"><span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span> :: x(:)</div>
<div class="line"><span class="keywordtype">type</span>(c_ptr) :: x_d</div>
<div class="line">...</div>
<div class="line"><span class="keyword">call </span>device_associate(x, x_d)</div>
</div><!-- fragment --><p> Once associated, the device pointer can be retrieved by calling the <a class="el" href="../../dd/d49/interfacedevice_1_1device__get__ptr.html" title="Return the device pointer for an associated Fortran array.">device::device_get_ptr</a> function, which returns the pointer associated with an array <code>x</code>. </p><div class="fragment"><div class="line"><span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span> :: x(:)</div>
<div class="line"><span class="keywordtype">type</span>(c_ptr) :: x_d</div>
<div class="line">...</div>
<div class="line">x_d = device_get_ptr(x)</div>
</div><!-- fragment --> <dl class="section attention"><dt>Attention</dt><dd><code>device_get_ptr</code> returns a fatal error unless <code>x</code> has been associated to a device pointer. If in doubt, use the routine <a class="el" href="../../d0/d30/interfacedevice_1_1device__associated.html" title="Check if a Fortran array is assoicated with a device pointer.">device::device_associated</a> to check the status of an array. <div class="fragment"><div class="line"><span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span> :: x(:)</div>
<div class="line"><span class="keywordtype">type</span>(c_ptr) :: x_d</div>
<div class="line">...</div>
<div class="line"><span class="keywordflow">if</span> (device_associated(x)) <span class="keywordflow">then</span></div>
<div class="line">   x_d = device_get_ptr(x)</div>
<div class="line"><span class="keyword">end </span>if</div>
</div><!-- fragment --></dd></dl>
<h3><a class="anchor" id="autotoc_md7"></a>
Map a host array to a device</h3>
<p>Since allocation and association is such an ordinary operation, Neko provides a combined routine <a class="el" href="../../da/db0/interfacedevice_1_1device__map.html" title="Map a Fortran array to a device (allocate and associate)">device::device_map</a> which takes a Fortran array <code>x</code> of type <code>integer</code>, <code>integer(i8)</code>, <code>real(kind=sp)</code> or <code>real(kind=dp)</code>, its size <code>n</code> (<b>Note</b> number of entries, not size in bytes as for <code>device_allocate</code>) and a C pointer <code>x_d</code> to the (to be allocated) device memory. </p><div class="fragment"><div class="line"><span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span> :: x(:)</div>
<div class="line"><span class="keywordtype">type</span>(c_ptr) :: x_d</div>
<div class="line"><span class="keywordtype">integer</span> :: n</div>
<div class="line">...</div>
<div class="line"><span class="keyword">allocate</span>(x(n))</div>
<div class="line">...</div>
<div class="line"><span class="keyword">call </span>device_map(x, x_d, n)</div>
</div><!-- fragment --><h3><a class="anchor" id="accelerators_data-transfer"></a>
Data transfer</h3>
<p>To copy data between host and device (and device to use) use the routine <a class="el" href="../../d6/dac/interfacedevice_1_1device__memcpy.html" title="Copy data between host and device (or device and device)">device::device_memcpy</a> which takes a Fortran array <code>x</code> of type <code>integer</code>, <code>integer(i8)</code>, <code>real(kind=sp)</code> or <code>real(kind=dp)</code>, its size <code>n</code> and the direction as the third argument which can either be <code>HOST_TO_DEVICE</code> to copy data to the device, or <code>DEVICE_TO_HOST</code> to retrieve data from the device. The fourth boolean argument, <code>sync</code>, controls whether the transfer is synchronous (<code>.true.</code>) or asynchronous (<code>.false.</code>). </p><div class="fragment"><div class="line"><span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span> :: x(:)</div>
<div class="line"><span class="keywordtype">type</span>(c_ptr) :: x_d</div>
<div class="line"><span class="keywordtype">integer</span> :: n</div>
<div class="line">...</div>
<div class="line"><span class="keyword">allocate</span>(x(n))</div>
<div class="line">...</div>
<div class="line"><span class="comment">! Fill the device with data</span></div>
<div class="line"><span class="keyword">call </span>device_memcpy(x, x_d, n, host_to_device, sync=.false.)</div>
<div class="line">...</div>
<div class="line"><span class="comment">! Retrieve data from device</span></div>
<div class="line"><span class="keyword">call </span>device_memcpy(x, x_d, n, device_to_host, sync=.true.)</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>that there's a special <a class="el" href="../../d0/dbe/namespacedevice.html#a81f988e9ec44109ae0e522585588e79a" title="Copy data between host and device (or device and device) (c-pointers)">device::device_memcpy_cptr</a> routine which only works with pointers, either on the host or the device, and the size needs to be given in bytes. This routine can be used to copy data between two arrays on a device with the direction <code>DEVICE_TO_DEVICE</code>. <div class="fragment"><div class="line"><span class="keywordtype">type</span>(c_ptr) :: x_d, y_d</div>
<div class="line"><span class="keywordtype">integer(c_size_t)</span> :: s</div>
<div class="line">...</div>
<div class="line"><span class="comment">! Copy the content of x into y on the device</span></div>
<div class="line"><span class="keyword">call </span>device_memcpy_cptr(y_d, x_d, s, device_to_device)</div>
</div><!-- fragment --></dd></dl>
<dl class="section attention"><dt>Attention</dt><dd><a class="el" href="../../d0/dbe/namespacedevice.html#a81f988e9ec44109ae0e522585588e79a" title="Copy data between host and device (or device and device) (c-pointers)">device::device_memcpy_cptr</a> defaults to asynchronous data transfer. The optional boolean argument <code>sync</code> must be true if synchronous transfers are needed. </dd>
<dd>
It is the programmers' responsibility to make sure that device arrays are kept in sync with the associated host array. Neko does not perform any implicit data movement.</dd></dl>
<h2><a class="anchor" id="accelerators_offload-work"></a>
Offload work</h2>
<p>To offload work to a device, most routines in Neko have a device version prefixed with <code>device_&lt;name of routine&gt;</code>. These routines have the same arguments as the host equivalent, but one must pass device pointers instead of Fortran arrays.</p>
<p>For example, we call the <code><a class="el" href="../../dd/d47/namespacemath.html#a7bd6ecfc03be3f80d20e06e85af6b791" title="Vector addition .">math::add2</a></code> routine to add two arrays together on the host. </p><div class="fragment"><div class="line"><span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span> :: x(:), y(:)</div>
<div class="line"><span class="keywordtype">integer</span> :: n</div>
<div class="line">...</div>
<div class="line"><span class="keyword">allocate</span>(x(n), y(n))</div>
<div class="line">...</div>
<div class="line"><span class="keyword">call </span>add2(x, y, n)</div>
</div><!-- fragment --><p> To offload the computation to the device, one must obtain the device pointers of <code>x</code> and <code>y</code>, and instead call <a class="el" href="../../d2/d73/namespacedevice__math.html#a01473fcab0cde33512431de42b050384" title="Vector addition .">device_math::device_add2</a> </p><div class="fragment"><div class="line"><span class="keywordtype">integer</span>, <span class="keywordtype">allocatable</span> :: x(:), y(:)</div>
<div class="line"><span class="keywordtype">type</span>(c_ptr) :: x_d, y_d</div>
<div class="line"><span class="keywordtype">integer</span> :: n</div>
<div class="line">...</div>
<div class="line"><span class="keyword">allocate</span>(x(n), y(n))</div>
<div class="line">...</div>
<div class="line">x_d = device_get_ptr(x)</div>
<div class="line">y_d = device_get_ptr(y)</div>
<div class="line"><span class="keyword">call </span>device_add2(x_d, y_d, n)</div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>Most derived types in Neko already contain one or several device pointers associated with its internal data. Thus the <code>device_get_ptr</code> call can often be omitted.</dd></dl>
<p>However, for type bound procedures, such as computing the matrix-vector product derived from <code>ax_t</code>, one should <b>always</b> call the same type bound procedure (in this case <code>compute</code>) as on the host. This is because derived types contain all the logic such that the fastest backend is always selected or is instantiated as a backend-specific type during initialisation (see for example <a class="el" href="../../d1/dd5/ax__helm__fctry_8f90.html">ax_helm_fctry.f90</a>) </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">Neko Manual</a></li><li class="navelem"><a class="el" href="../../dc/d70/developer-guide.html">Developer guide</a></li>
    <li class="footer">Generated on Mon Dec 16 2024 03:43:30 for Neko by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>

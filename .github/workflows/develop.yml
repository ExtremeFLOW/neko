name: develop

# Controls when the action will run.
on:
  pull_request:
    branches: [develop, release/*]
    types:
      - opened
      - synchronize
      - reopened
      - ready_for_review
  workflow_dispatch:

  # Todo: this should be removed once the rework is done.
  push:
    branches: [cicd/rework]

# Allow only one concurrent deployment, skipping runs queued between the run
# in-progress and latest queued. We do not wish to waste time on old runs if a
# newer one is available.
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true
env:
  JSON_FORTRAN_VERSION: 8.3.0

jobs:
  is_draft:
    name: Check if PR is a draft
    if: github.event.pull_request.draft == true

    runs-on: ubuntu-latest
    steps:
      - name: Check if PR is a draft
        run: echo "This PR is a draft"

  linting:
    name: Flint
    needs: is_draft
    uses: ./.github/workflows/lint.yml
    with:
      global_minimum_score: 8.0
      changed_files_minimum_score: 8.0

  GNU:
    needs:
      - is_draft
      - linting
    uses: ./.github/workflows/check_gnu.yml
    with:
      json-fortran-version: ${{ env.JSON_FORTRAN_VERSION }}
      pfunit-version: v4.4.2

  Intel:
    needs:
      - is_draft
      - linting
    uses: ./.github/workflows/check_intel.yml
    with:
      json-fortran-version: ${{ env.JSON_FORTRAN_VERSION }}

  NVIDIA:
    needs:
      - is_draft
      - linting
    uses: ./.github/workflows/check_nvidia.yml
    with:
      json-fortran-version: ${{ env.JSON_FORTRAN_VERSION }}

  ReFrame:
    needs:
      - is_draft
      - linting
    uses: ./.github/workflows/check_reframe.yml
    with:
      json-fortran-version: ${{ env.JSON_FORTRAN_VERSION }}

name: develop

# Controls when the action will run. 
on:
  pull_request:
     branches: [develop]
  workflow_dispatch:
  
jobs:
  GNU:
    
    runs-on: ${{matrix.os}}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-20.04, macos-latest]
        compiler: [gfortran-10, gfortran-11]
        backend: [cpu, cuda, hip, opencl]
        precision: [sp, dp]
        exclude:
        - os: ubuntu-20.04
          compiler: gfortran-11
        - os: ubuntu-20.04
          backend: opencl
        - os: macos-latest
          compiler: gfortran-10
        - os: macos-latest
          backend: cuda
        - os: macos-latest
          backend: hip
        include:
        - os: ubuntu-20.04
          setup-env: sudo apt-get update && sudo apt-get install -y openmpi-bin libopenmpi-dev autoconf automake autotools-dev libopenblas-dev make git m4 python3  cmake-curses-gui
        - os: macos-latest
          setup-env: brew update && brew install openmpi && brew install automake
    env:
      FC: ${{ matrix.compiler }}
      OMPI_FC: ${{ matrix.compiler }}
      OMPI_ALLOW_RUN_AS_ROOT: 1
      OMPI_ALLOW_RUN_AS_ROOT_CONFIRM: 1
      OMPI_MCA_btl_vader_single_copy_mechanism: none
      RP: ${{ matrix.precision }}
    name: ${{ matrix.os }} / ${{ matrix.compiler }} / ${{ matrix.backend }} / ${{ matrix.precision }}
    steps:
      - name: Setup env.
        run: ${{ matrix.setup-env }}
      - name: Cache pFUnit
        id: cache-pfunit
        uses: actions/cache@v2
        with:
          path: ~/pkg/pfunit
          key: pfunit-${{ runner.os }}-${{ matrix.os }}-${{ matrix.compiler }}
      - name: Build pFUnit
        if: ${{ (steps.cache-pfunit.outputs.cache-hit != 'true') && (matrix.backend == 'cpu') }}
        run: |
          git clone https://github.com/Goddard-Fortran-Ecosystem/pFUnit.git
          cd pFUnit && mkdir b && cd b
          cmake -DCMAKE_INSTALL_PREFIX=${HOME}/pkg/pfunit ..
          make -j$(nproc) && make install && cd ../../
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 1
      - name: Build (CPU backend)
        if: matrix.backend == 'cpu'
        run: |
          ./regen.sh 
          ./configure FC=${FC} FCFLAGS="-O2 -pedantic -std=f2008"  --with-pfunit=${HOME}/pkg/pfunit/PFUNIT-4.4 --enable-real=${RP}
          make -j$(nproc)
      - name: Build (CUDA backend)        
        if: matrix.backend == 'cuda'
        run: |
          sudo apt-get install -y nvidia-cuda-toolkit
          ./regen.sh 
          ./configure FC=${FC} FCFLAGS="-O2 -pedantic -std=f2008"  --enable-real=${RP} --with-cuda=/usr
          make -j$(nproc)
      - name: Build (HIP backend)        
        if: matrix.backend == 'HIP'
        run: |
          wget -q -O - https://repo.radeon.com/rocm/rocm.gpg.key | sudo apt-key add -
          echo 'deb [arch=amd64] https://repo.radeon.com/rocm/apt/debian/ ubuntu main' | sudo tee /etc/apt/sources.list.d/rocm.list
          sudo apt-get update && sudo apt-get install -y rocm-dev
          source /etc/profile.d/rocm.sh
          ./regen.sh 
          ./configure FC=${FC} FCFLAGS="-O2 -pedantic -std=f2008 -fPIC"  --enable-real=${RP} --with-hip=/opt/rocm/hip
          make -j$(nproc)
      - name: Build (OpenCL backend)
        if: matrix.backend == 'opencl'
        run: |
          ./regen.sh 
          ./configure FC=${FC} FCFLAGS="-O2 -pedantic -std=f2008"  --enable-real=${RP} --with-opencl
          make -j$(nproc)
      - name: Check
        if: matrix.backend == 'cpu'
        run: |
          make -j$(nproc) check
      - name: Dist (CPU backend)
        if: matrix.backend == 'cpu'
        run: |
          make dist
          mkdir releng
          tar xf neko-*.tar.gz -C releng
          cd releng/neko-*
          ./configure FC=${FC} --enable-real=${RP}
          make -j $(nproc)
      - name: Dist (CUDA backend)
        if: matrix.backend == 'cuda'
        run: |
          make dist
          mkdir releng
          tar xf neko-*.tar.gz -C releng
          cd releng/neko-*
          ./configure FC=${FC} --enable-real=${RP} --with-cuda=/usr
          make -j $(nproc)
      - name: Dist (HIP backend)
        if: matrix.backend == 'hip'
        run: |
          make dist
          mkdir releng
          tar xf neko-*.tar.gz -C releng
          cd releng/neko-*
          ./configure FC=${FC} --enable-real=${RP} --with-cuda=/opt/rocm/hip
          make -j $(nproc)
      - name: Dist (OpenCL backend)
        if: matrix.backend == 'opencl'
        run: |
          make dist
          mkdir releng
          tar xf neko-*.tar.gz -C releng
          cd releng/neko-*
          ./configure FC=${FC} --enable-real=${RP} --with-opencl
          make -j $(nproc)
    
  Intel:
    runs-on: ${{matrix.os}}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-20.04]
        compiler: [ifort, ifx]
        precision: [sp, dp]
        backend: [cpu]
        exclude:
        - os: ubuntu-20.04
          compiler: ifx
        include:
        - os: ubuntu-20.04
          setup-env: cd /tmp && wget https://apt.repos.intel.com/intel-gpg-keys/GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB && sudo apt-key add GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB && rm GPG-PUB-KEY-INTEL-SW-PRODUCTS.PUB && sudo add-apt-repository "deb https://apt.repos.intel.com/oneapi all main" && sudo apt install --no-install-recommends intel-oneapi-compiler-fortran intel-oneapi-mpi intel-oneapi-mpi-devel intel-oneapi-compiler-dpcpp-cpp-and-cpp-classic && source /opt/intel/oneapi/setvars.sh && sudo apt install -y autoconf automake autotools-dev libopenblas-dev make git m4 python3 ca-certificates && printenv >> $GITHUB_ENV
    env:
      CC: icc
      FC: ${{ matrix.compiler }}
      RP: ${{ matrix.precision }}
    name: ${{ matrix.os }} / ${{ matrix.compiler }} / ${{ matrix.backend }} / ${{ matrix.precision }}
    steps:
      - name: Setup env.
        run: ${{ matrix.setup-env }}
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 1
      - name: Build
        run: |
          ./regen.sh
          ./configure FC=${FC} CC=${CC} MPIFC"=mpiifort -fc=${FC}" --enable-real=${RP} 
          make FCFLAGS="-O2 -stand f08 -warn errors" -j$(nproc)
            
            
 
